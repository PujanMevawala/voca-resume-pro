import React, { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import AnimatedPage from '../components/AnimatedPage';
import Button from '../components/Button';
import { toast } from 'sonner';
import { api } from '../services/api';
import Gauge from '../components/Gauge';

export default function Analysis({ token }) {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const resumeId = searchParams.get('resumeId');

  const [loading, setLoading] = useState(false);
  const [resumeInfo, setResumeInfo] = useState(null);
  const [jobDescription, setJobDescription] = useState('');
  const [selectedModel, setSelectedModel] = useState('gemini-2.0-flash-exp');
  const [availableModels] = useState([
    { id: 'gemini-2.0-flash-exp', name: 'Gemini 2.0 Flash', provider: 'google' },
    { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', provider: 'google' },
    { id: 'grok-beta', name: 'Grok Beta', provider: 'xai' },
    { id: 'llama3.1', name: 'Llama 3.1 (Local)', provider: 'ollama' },
  ]);
  
  const [strengths, setStrengths] = useState([]);
  const [weaknesses, setWeaknesses] = useState([]);
  const [suggestions, setSuggestions] = useState([]);
  const [interviewQuestions, setInterviewQuestions] = useState([]);
  const [jobFitScore, setJobFitScore] = useState(null);
  const [analysisSummary, setAnalysisSummary] = useState('');
  const [audioUrl, setAudioUrl] = useState(null);
  const [generatingAudio, setGeneratingAudio] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');

  useEffect(() => {
    if (!resumeId) {
      toast.error('No resume selected');
      navigate('/documents');
      return;
    }
    if (!token) {
      navigate('/login');
      return;
    }
    loadResumeInfo();
  }, [resumeId, token, navigate]);

  const checkResumeStatus = async () => {
    let pollCount = 0;
    const maxPolls = 30;
    
    try {
      const data = await api.get(`/api/resume/${resumeId}`, token);
      setResumeStatus(data.status);
      setResumeReady(data.status === 'ready' && data.hasText);
      setResumeFilename(data.filename || '');
      
      if (data.status === 'processing') {
        toast.info('Processing resume... (10-15 seconds expected)');
        
        const poll = async () => {
          pollCount++;
          try {
            const updated = await api.get(`/api/resume/${resumeId}`, token);
            setResumeStatus(updated.status);
            setResumeFilename(updated.filename || '');
            
            if (updated.status === 'ready' && updated.hasText) {
              setResumeReady(true);
              toast.success('Resume ready! You can now run analysis.');
              return; // Stop polling
            } else if (updated.status === 'error') {
              toast.error('Resume processing failed. Please try uploading again.');
              return; // Stop polling
            } else if (pollCount >= maxPolls) {
              toast.error('Processing timeout. Please refresh and try again.');
              return; // Stop polling
            }
            
            // Continue polling with exponential backoff
            const delay = Math.min(1000 * Math.pow(1.5, Math.floor(pollCount / 5)), 5000);
            pollIntervalRef.current = setTimeout(poll, delay);
          } catch (e) {
            console.error('Poll error:', e);
            // Stop polling on auth errors
            if (e.message?.includes('401') || e.message?.includes('Authentication')) {
              toast.error('Session expired. Please login again.');
              navigate('/login');
            }
          }
        };
        
        pollIntervalRef.current = setTimeout(poll, 2000); // Start after 2 seconds
      } else if (data.status === 'ready') {
        if (data.summary) {
          setSummary(data.summary);
        }
      }
    } catch (e) {
      console.error('Failed to check resume status:', e);
      toast.error('Failed to check resume status');
    }
  };

  // Cleanup polling timeout on unmount
  useEffect(() => {
    return () => {
      if (pollIntervalRef.current) {
        clearTimeout(pollIntervalRef.current);
        pollIntervalRef.current = null;
      }
    };
  }, []);

  const generateSummary = async () => {
    if (!resumeReady) {
      toast.error('Resume is still processing. Please wait...');
      return;
    }
    setLoading(true);
    try {
      const data = await api.post('/api/resume/summary', { resumeId }, token);
      setSummary(data.summary || '');
      toast.success('Summary generated!');
    } catch (e) {
      console.error('Failed to generate summary:', e);
      toast.error('Failed to generate summary');
    } finally {
      setLoading(false);
    }
  };

  const loadProviders = async () => {
    try {
      const data = await api.get('/api/analysis/providers', token);
      setProviders(data.providers || []);
    } catch (e) {
      console.error('Failed to load providers:', e);
    }
  };

  const runFullAnalysis = async () => {
    if (!resumeId) return;
    if (!resumeReady) {
      toast.error('Resume is still processing. Please wait...');
      return;
    }
    setLoading(true);
    try {
      const data = await api.post('/api/analysis/full', {
        resumeId,
        jobDescription: jobDescription.trim() || undefined,
        provider,
      }, token);

      setAnalysis(data.analysis);
      setSuggestions(data.suggestions);
      setInterviewQuestions(data.interviewQuestions);
      setJobFitScore(data.jobFitScore);
      setScript(data.script);
      toast.success('Analysis complete!');
    } catch (e) {
      toast.error(e.message || 'Analysis failed');
    } finally {
      setLoading(false);
    }
  };

  const runIndividualAnalysis = async (endpoint, setter, successMsg) => {
    if (!resumeId) return;
    setLoading(true);
    try {
      const data = await api.post(endpoint, {
        resumeId,
        jobDescription: jobDescription.trim() || undefined,
        provider,
      }, token);
      setter(data);
      toast.success(successMsg);
    } catch (e) {
      toast.error(e.message || 'Failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <AnimatedPage>
      <div className="max-w-7xl mx-auto pt-14 px-4">
        <div className="mb-8">
          <h1 className="text-3xl font-bold bg-gradient-to-r from-brand-500 to-purple-500 bg-clip-text text-transparent">
            Resume Analysis
          </h1>
          <p className="text-slate-600 dark:text-slate-400 mt-2">
            {resumeFilename ? `Analyzing: ${resumeFilename}` : 'Get comprehensive insights, suggestions, and interview prep'}
          </p>
          
          {/* Resume Status Indicator */}
          <div className="mt-4">
            {resumeStatus === 'processing' && (
              <div className="flex items-center gap-2 text-amber-600 dark:text-amber-400">
                <ArrowPathIcon className="w-5 h-5 animate-spin" />
                <span className="text-sm font-medium">Processing resume... Please wait.</span>
              </div>
            )}
            {resumeStatus === 'ready' && resumeReady && (
              <div className="flex items-center gap-2 text-green-600 dark:text-green-400">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
                <span className="text-sm font-medium">Resume ready for analysis</span>
              </div>
            )}
            {resumeStatus === 'error' && (
              <div className="flex items-center gap-2 text-red-600 dark:text-red-400">
                <span className="text-sm font-medium">‚ö†Ô∏è Resume processing failed. Please try uploading again.</span>
              </div>
            )}
          </div>
        </div>

        {/* Job Description Input */}
        <Card className="mb-6">
          <h2 className="text-xl font-semibold mb-4">Job Description (Optional)</h2>
          <textarea
            rows={6}
            className="w-full rounded-md border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 p-3 outline-none focus:ring-2 focus:ring-brand-400"
            placeholder="Paste the job description here to get tailored analysis and fit score..."
            value={jobDescription}
            onChange={(e) => setJobDescription(e.target.value)}
          />
          
          <div className="flex items-center gap-4 mt-4">
            <select
              value={provider}
              onChange={(e) => setProvider(e.target.value)}
              className="rounded-md border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/50 px-3 py-2 outline-none focus:ring-2 focus:ring-brand-400"
            >
              <option value="auto">Auto (Best Available)</option>
              {providers.filter(p => p.available).map(p => (
                <option key={p.id} value={p.id}>{p.name}</option>
              ))}
            </select>

            <Button onClick={runFullAnalysis} disabled={loading || !resumeReady} className="flex items-center gap-2">
              {loading ? <ArrowPathIcon className="w-5 h-5 animate-spin" /> : <SparklesIcon className="w-5 h-5" />}
              Run Full Analysis
            </Button>
          </div>
        </Card>

        {/* Analysis Tabs */}
        <Card className="mb-6">
          <div className="flex flex-wrap gap-2 mb-6 border-b border-slate-200 dark:border-slate-700">
            <button
              onClick={() => setActiveTab('summary')}
              className={`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${
                activeTab === 'summary'
                  ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                  : 'border-transparent text-slate-600 dark:text-slate-400 hover:text-brand-500'
              }`}
            >
              Summary
            </button>
            <button
              onClick={() => setActiveTab('strengths')}
              className={`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${
                activeTab === 'strengths'
                  ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                  : 'border-transparent text-slate-600 dark:text-slate-400 hover:text-brand-500'
              }`}
            >
              Strengths & Weaknesses
            </button>
            <button
              onClick={() => setActiveTab('suggestions')}
              className={`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${
                activeTab === 'suggestions'
                  ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                  : 'border-transparent text-slate-600 dark:text-slate-400 hover:text-brand-500'
              }`}
            >
              Improvement Suggestions
            </button>
            <button
              onClick={() => setActiveTab('interview')}
              className={`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${
                activeTab === 'interview'
                  ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                  : 'border-transparent text-slate-600 dark:text-slate-400 hover:text-brand-500'
              }`}
            >
              Interview Questions
            </button>
            <button
              onClick={() => setActiveTab('jobfit')}
              className={`px-4 py-2 font-medium text-sm transition-colors border-b-2 ${
                activeTab === 'jobfit'
                  ? 'border-brand-500 text-brand-600 dark:text-brand-400'
                  : 'border-transparent text-slate-600 dark:text-slate-400 hover:text-brand-500'
              }`}
            >
              Job Fit Score
            </button>
          </div>

          {/* Tab Content */}
          {activeTab === 'summary' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">Professional Summary</h2>
                <Button 
                  variant="secondary" 
                  size="sm"
                  onClick={generateSummary}
                  disabled={loading || !resumeReady}
                >
                  {loading ? 'Generating...' : 'Generate'}
                </Button>
              </div>
              {summary ? (
                <p className="text-slate-700 dark:text-slate-300 leading-relaxed whitespace-pre-wrap">
                  {summary}
                </p>
              ) : (
                <p className="text-slate-500 dark:text-slate-400 text-sm italic">
                  Click "Generate" to create a professional summary of your resume
                </p>
              )}
            </div>
          )}

          {activeTab === 'strengths' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">Strengths & Weaknesses Analysis</h2>
                <Button 
                  variant="secondary" 
                  size="sm"
                  onClick={() => runIndividualAnalysis('/api/analysis/strengths', setAnalysis, 'Analysis complete!')}
                  disabled={loading || !resumeReady}
                >
                  {loading ? 'Analyzing...' : 'Analyze'}
                </Button>
              </div>
              {analysis ? (
                <div className="space-y-4">
                  <div>
                    <h3 className="text-sm font-medium text-green-600 dark:text-green-400 mb-2">‚úì Strengths</h3>
                    <ul className="space-y-1">
                      {analysis.strengths?.map((s, i) => (
                        <li key={i} className="text-sm text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {s}</li>
                      ))}
                    </ul>
                  </div>
                  <div>
                    <h3 className="text-sm font-medium text-amber-600 dark:text-amber-400 mb-2">‚ö† Weaknesses</h3>
                    <ul className="space-y-1">
                      {analysis.weaknesses?.map((w, i) => (
                        <li key={i} className="text-sm text-slate-700 dark:text-slate-300 pl-4">‚Ä¢ {w}</li>
                      ))}
                    </ul>
                  </div>
                </div>
              ) : (
                <p className="text-slate-500 dark:text-slate-400 text-sm italic">
                  Click "Analyze" to identify your resume's strengths and areas for improvement
                </p>
              )}
            </div>
          )}

          {activeTab === 'suggestions' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">Improvement Suggestions</h2>
                <Button 
                  variant="secondary" 
                  size="sm"
                  onClick={() => runIndividualAnalysis('/api/analysis/suggestions', setSuggestions, 'Suggestions generated!')}
                  disabled={loading || !resumeReady}
                >
                  {loading ? 'Generating...' : 'Generate'}
                </Button>
              </div>
              {suggestions ? (
                <ul className="space-y-3">
                  {suggestions.suggestions?.map((suggestion, i) => (
                    <li key={i} className="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                      <p className="text-sm text-slate-700 dark:text-slate-300">{suggestion}</p>
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-slate-500 dark:text-slate-400 text-sm italic">
                  Click "Generate" to get personalized suggestions to improve your resume
                </p>
              )}
            </div>
          )}

          {activeTab === 'interview' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">Interview Questions</h2>
                <Button 
                  variant="secondary" 
                  size="sm"
                  onClick={() => runIndividualAnalysis('/api/analysis/interview', setInterviewQuestions, 'Questions generated!')}
                  disabled={loading || !resumeReady}
                >
                  {loading ? 'Generating...' : 'Generate'}
                </Button>
              </div>
              {jobDescription.trim() === '' && (
                <div className="mb-4 p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                  <p className="text-sm text-amber-800 dark:text-amber-200">
                    üí° Tip: Add a job description above to get role-specific interview questions
                  </p>
                </div>
              )}
              {interviewQuestions ? (
                <ul className="space-y-3">
                  {interviewQuestions.questions?.map((q, i) => (
                    <li key={i} className="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                      <p className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Q{i + 1}: {q.question}</p>
                      {q.hint && (
                        <p className="text-xs text-slate-600 dark:text-slate-400 italic">Hint: {q.hint}</p>
                      )}
                    </li>
                  ))}
                </ul>
              ) : (
                <p className="text-slate-500 dark:text-slate-400 text-sm italic">
                  Click "Generate" to get interview questions based on your resume {jobDescription.trim() && 'and the job description'}
                </p>
              )}
            </div>
          )}

          {activeTab === 'jobfit' && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">Job Fit Score</h2>
                <Button 
                  variant="secondary" 
                  size="sm"
                  onClick={() => runIndividualAnalysis('/api/analysis/jobfit', setJobFitScore, 'Score calculated!')}
                  disabled={loading || !resumeReady || !jobDescription.trim()}
                >
                  {loading ? 'Calculating...' : 'Calculate'}
                </Button>
              </div>
              {!jobDescription.trim() ? (
                <div className="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                  <p className="text-sm text-amber-800 dark:text-amber-200">
                    ‚ö†Ô∏è Please add a job description above to calculate your job fit score
                  </p>
                </div>
              ) : jobFitScore ? (
                <div className="flex flex-col items-center">
                  <Gauge value={jobFitScore.score || 0} />
                  <p className="text-sm text-slate-600 dark:text-slate-400 mt-4 text-center">
                    {jobFitScore.explanation}
                  </p>
                  {jobFitScore.matchedSkills && (
                    <div className="mt-4 w-full">
                      <h3 className="text-sm font-medium text-green-600 dark:text-green-400 mb-2">Matched Skills</h3>
                      <div className="flex flex-wrap gap-2">
                        {jobFitScore.matchedSkills.map((skill, i) => (
                          <span key={i} className="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 text-xs rounded">
                            {skill}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                  {jobFitScore.missingSkills && (
                    <div className="mt-4 w-full">
                      <h3 className="text-sm font-medium text-red-600 dark:text-red-400 mb-2">Missing Skills</h3>
                      <div className="flex flex-wrap gap-2">
                        {jobFitScore.missingSkills.map((skill, i) => (
                          <span key={i} className="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 text-xs rounded">
                            {skill}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <p className="text-slate-500 dark:text-slate-400 text-sm italic">
                  Click "Calculate" to see how well your resume matches the job description
                </p>
              )}
            </div>
          )}
        </Card>
      </div>
    </AnimatedPage>
  );
}
